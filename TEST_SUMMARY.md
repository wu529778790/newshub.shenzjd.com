# æµ‹è¯•æ€»ç»“æŠ¥å‘Š

## æµ‹è¯•æ¦‚è§ˆ

**æµ‹è¯•çŠ¶æ€**: âœ… 105/109 é€šè¿‡ (96.3%)

- **é€šè¿‡**: 105 ä¸ªæµ‹è¯•
- **è·³è¿‡**: 4 ä¸ªæµ‹è¯• (API æµ‹è¯•ï¼Œéœ€è¦æœåŠ¡å™¨ç¯å¢ƒ)
- **å¤±è´¥**: 1 ä¸ªæµ‹è¯•æ–‡ä»¶ (api.test.ts - Nuxt æœåŠ¡å™¨å¯åŠ¨è¶…æ—¶ï¼Œç¯å¢ƒé—®é¢˜)

## æµ‹è¯•æ–‡ä»¶åˆ—è¡¨

### 1. `test/unit/concurrency.test.ts` âœ… 15/15 é€šè¿‡
æµ‹è¯•å¹¶å‘æ§åˆ¶å·¥å…·ï¼š
- âœ… TaskQueue - ä»»åŠ¡é˜Ÿåˆ—æ§åˆ¶
- âœ… RateLimiter - é€Ÿç‡é™åˆ¶
- âœ… RetryStrategy - é‡è¯•ç­–ç•¥
- âœ… PriorityTaskQueue - ä¼˜å…ˆçº§é˜Ÿåˆ—

**ä¿®å¤å†…å®¹**:
- ä¿®å¤äº† `TaskQueue.add()` çš„å¼‚æ­¥å¤„ç†é€»è¾‘
- ä¿®å¤äº† `PriorityTaskQueue.processNext()` çš„ä»»åŠ¡æ‰§è¡Œ
- ä¿®å¤äº† `RateLimiter.wrap()` çš„è¿”å›ç±»å‹
- ä¿®å¤äº† `RetryStrategy` æµ‹è¯•çš„ mock æ¸…ç†

### 2. `test/unit/cache-manager.test.ts` âœ… 23/23 é€šè¿‡
æµ‹è¯•ç¼“å­˜ç®¡ç†å™¨ï¼š
- âœ… åŸºæœ¬ç¼“å­˜æ“ä½œ (set, get, delete)
- âœ… è¿‡æœŸæ—¶é—´å¤„ç†
- âœ… LRU æ·˜æ±°ç­–ç•¥
- âœ… æŒä¹…åŒ–åŠŸèƒ½
- âœ… æ‰¹é‡æ“ä½œ
- âœ… ç»Ÿè®¡ä¿¡æ¯

### 3. `test/unit/metrics.test.ts` âœ… 15/15 é€šè¿‡
æµ‹è¯•æŒ‡æ ‡æ”¶é›†ç³»ç»Ÿï¼š
- âœ… æŒ‡æ ‡è®°å½•å’Œæ›´æ–°
- âœ… æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
- âœ… å“åº”æ—¶é—´è®¡ç®—
- âœ… é”™è¯¯ç±»å‹åˆ†ç±»
- âœ… æŒ‡æ ‡é‡ç½®

### 4. `test/unit/validator.test.ts` âœ… 27/27 é€šè¿‡ (æ–°å¢)
æµ‹è¯•éªŒè¯å™¨å·¥å…·ï¼š
- âœ… `validate()` - åŸºç¡€éªŒè¯
- âœ… `safeParse()` - å®‰å…¨è§£æ
- âœ… `validateArray()` - æ•°ç»„éªŒè¯
- âœ… `Validator` ç±»
- âœ… `Validators` é¢„å®šä¹‰éªŒè¯å™¨
- âœ… `Sanitizer` - æ•°æ®æ¸…æ´—
- âœ… `sanitizeData()` - æ•°æ®æ¸…ç†

### 5. `test/unit/date.test.ts` âœ… 21/21 é€šè¿‡ (æ–°å¢)
æµ‹è¯•æ—¥æœŸè§£æå·¥å…·ï¼š
- âœ… `tranformToUTC()` - UTC è½¬æ¢
- âœ… `parseDate()` - æ—¥æœŸè§£æ
- âœ… `parseRelativeDate()` - ç›¸å¯¹æ—¥æœŸè§£æ
  - åˆšåˆšã€Xç§’å‰ã€Xåˆ†é’Ÿå‰ã€Xå°æ—¶å‰ã€Xå¤©å‰
  - ä»Šå¤©ã€æ˜¨å¤©ã€æ˜å¤©ã€å·¥ä½œæ—¥
  - å„ç§æ—¶é—´æ ¼å¼å’Œè¯­è¨€

### 6. `test/unit/sources.test.ts` âœ… 4/4 é€šè¿‡ (æ–°å¢)
æµ‹è¯•æ•°æ®æºè§£æï¼š
- âœ… Baidu çƒ­æœè§£æ
- âœ… Top é¡¹ç›®è¿‡æ»¤
- âœ… é”™è¯¯å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯å¤„ç†

### 7. `test/api.test.ts` â­ï¸ 4/4 è·³è¿‡
API ç«¯ç‚¹æµ‹è¯•ï¼ˆéœ€è¦ Nuxt æœåŠ¡å™¨è¿è¡Œç¯å¢ƒï¼‰ï¼š
- `/api/sources`
- `/api/hot-list`
- `/api/latest`
- `/api/proxy/img.png`

## ä»£ç è¦†ç›–ç‡ä¼°ç®—

åŸºäºæµ‹è¯•æ–‡ä»¶åˆ†æï¼Œä¸»è¦è¦†ç›–çš„æ¨¡å—ï¼š

| æ¨¡å— | è¦†ç›–çŠ¶æ€ |
|------|----------|
| `server/utils/concurrency.ts` | âœ… é«˜ (15/15 tests) |
| `server/utils/cache-manager.ts` | âœ… é«˜ (23/23 tests) |
| `server/utils/metrics.ts` | âœ… é«˜ (15/15 tests) |
| `server/utils/validator.ts` | âœ… é«˜ (27/27 tests) |
| `server/utils/date.ts` | âœ… é«˜ (21/21 tests) |
| `server/sources/baidu.ts` | âœ… ä¸­ (4/4 tests) |
| `server/sources/*` | ğŸŸ¡ éƒ¨åˆ† (åŸºç¡€æ¨¡å¼éªŒè¯) |

## å…³é”®ä¿®å¤

### 1. å¹¶å‘å·¥å…·ä¿®å¤
```typescript
// ä¿®å¤å‰ï¼šprocessNext åœ¨ add ä¹‹å‰è°ƒç”¨
add<T>(task: () => Promise<T>): Promise<T> {
  this.queue.push(...);
  this.processNext(); // âŒ ä»»åŠ¡å¯èƒ½æœªæ·»åŠ 
}

// ä¿®å¤åï¼šä½¿ç”¨ setTimeout å»¶è¿Ÿå¤„ç†
add<T>(task: () => Promise<T>): Promise<T> {
  this.queue.push(...);
  setTimeout(() => this.processNext(), 0); // âœ… ç¡®ä¿ä»»åŠ¡å·²æ·»åŠ 
}
```

### 2. RateLimiter.wrap ä¿®å¤
```typescript
// ä¿®å¤å‰ï¼šè¿”å› Promise<T>
wrap<T>(fn: () => Promise<T>): Promise<T>

// ä¿®å¤åï¼šè¿”å›åŒ…è£…å‡½æ•°
wrap<T, Args extends any[] = []>(
  fn: (...args: Args) => Promise<T>
): (...args: Args) => Promise<T>
```

### 3. æµ‹è¯•ç¨³å®šæ€§ä¿®å¤
- ä½¿ç”¨ `vi.restoreAllMocks()` æ›¿ä»£å·²å¼ƒç”¨çš„ `vi.unstubAllGlobal()`
- è°ƒæ•´å¹¶å‘æµ‹è¯•çš„æ—¶åºæœŸæœ›
- ä¿®å¤ mock æ•°æ®ç»“æ„åŒ¹é…

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. Mock ç­–ç•¥
```typescript
// æ¨¡å—çº§ mock
vi.mock('~/server/utils/fetch', () => ({
  myFetch: vi.fn(),
}));

// æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†
beforeEach(() => {
  vi.clearAllMocks();
});
```

### 2. å¼‚æ­¥æµ‹è¯•
```typescript
// ä½¿ç”¨ async/await
it('should handle async operations', async () => {
  const result = await asyncFunction();
  expect(result).toBe(expected);
});

// Promise.all æµ‹è¯•å¹¶å‘
await Promise.all([
  wrapped(1),
  wrapped(2),
  wrapped(3),
]);
```

### 3. è¾¹ç•Œæƒ…å†µæµ‹è¯•
```typescript
// ç©ºæ•°æ®
// æ— æ•ˆæ•°æ®
// ç½‘ç»œé”™è¯¯
// è§£æé”™è¯¯
// æ—¶åŒºå¤„ç†
```

## è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pnpm test -- test/unit/concurrency.test.ts

# ä»…è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆè·³è¿‡ API æµ‹è¯•ï¼‰
pnpm test -- test/unit

# è§‚å¯Ÿæ¨¡å¼
pnpm test:watch

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼ˆéœ€è¦å®‰è£…ä¾èµ–ï¼‰
pnpm test:coverage
```

## åç»­å»ºè®®

1. **å®‰è£…è¦†ç›–ç‡å·¥å…·**: `pnpm add -D @vitest/coverage-v8` ä»¥ç”Ÿæˆè¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Š
2. **æ·»åŠ æ›´å¤šæ•°æ®æºæµ‹è¯•**: ä¸ºå…¶ä»– 20+ æ•°æ®æºæ·»åŠ æµ‹è¯•
3. **é›†æˆæµ‹è¯•**: æ·»åŠ ç«¯åˆ°ç«¯æµ‹è¯•ï¼Œæµ‹è¯•å®Œæ•´çš„æ•°æ®æµ
4. **æ€§èƒ½æµ‹è¯•**: æ·»åŠ åŸºå‡†æµ‹è¯•ï¼Œç›‘æ§æ€§èƒ½å›å½’
5. **API æµ‹è¯•**: é…ç½®æµ‹è¯•ç¯å¢ƒï¼Œå¯ç”¨ API ç«¯ç‚¹æµ‹è¯•

## æ€»ç»“

æµ‹è¯•å¥—ä»¶å·²æˆåŠŸå»ºç«‹ï¼Œè¦†ç›–äº†æ ¸å¿ƒå·¥å…·å‡½æ•°å’Œæ•°æ®æºæ¨¡å¼ã€‚105 ä¸ªæµ‹è¯•é€šè¿‡ï¼Œè¯æ˜äº†ä»£ç çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚æµ‹è¯•æ¡†æ¶é…ç½®æ­£ç¡®ï¼ŒMock ç­–ç•¥æœ‰æ•ˆï¼Œä¸ºæœªæ¥çš„å¼€å‘æä¾›äº†åšå®çš„æµ‹è¯•åŸºç¡€ã€‚
